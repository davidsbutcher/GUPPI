---
title: "GUPPI Output Report"
date: "`r format(Sys.time(), '%B %d, %Y')`"

output: 
  flexdashboard::flex_dashboard:
    self_contained: TRUE
    logo: "../css/MagLab-Color-FTICR-Logo.png"
    css: "../css/maglab_theme.css"
    orientation: rows
    horizontal_layout: scroll
    vertical_layout: scroll
    navbar: 
          - {title: "Github", icon: "fa-github", href: "http://github.com/davidsbutcher/GUPPI", align: right}
          - {title: "NHMFL/ICR", icon: "fa-magnet", href: "https://nationalmaglab.org/user-facilities/icr", align: right}

---

```{r setup, include=FALSE}

# knitr::opts_knit$set(base.dir = normalizePath(tempdir(), winslash = '/'))

library(flexdashboard)
library(magrittr)
library(stringr)
library(purrr)
library(forcats)
library(UpSetR)
library(ggplot2)
library(DT)
library(plotly)
library(ggthemes)
library(viridis)
library(waffle)
library(dplyr)
library(sessioninfo)
library(fontawesome)

if (is.null(fractionAssignments) == TRUE) {
  fracAss = "Automatic"
} else {
  fracAss = "Manual"
}

```

# Summary

Row {data-width=600}
-----------------------------------------------------------------------

```{r include=FALSE}

unique_PTMs <- 
  results_proteoform_modcounts %>% 
  dplyr::group_by(tdreport_name) %>% 
  dplyr::summarize(UniquePTMs = length(unique(ModificationName))) %>% 
  dplyr::pull(UniquePTMs)

most_popular_name <- 
  results_proteoform_modcounts %>% 
  dplyr::group_by(tdreport_name) %>% 
  dplyr::filter(Count == max(Count)) %>% 
  dplyr::pull(ModificationName)

most_popular_count <- 
  results_proteoform_modcounts %>% 
  dplyr::group_by(tdreport_name) %>% 
  dplyr::filter(Count == max(Count)) %>% 
  dplyr::pull(Count)

```

### `r htmltools::tags$h4("Files analyzed")`

```{r}

GUPPI_version <- 
  sessioninfo::session_info()$packages %>%
  dplyr::filter(package == "GUPPI") %>%
  .$loadedversion

tibble(
  `tdReport Name` = map(filelist, basename) %>% unlist(),
  `Protein Count` = map(proteinlist, nrow) %>% unlist(),
  `Proteoform Count` = map(proteoformlist, nrow) %>% unlist(),
  `Unique PTM Count` = unique_PTMs,
  `Most common PTM` = most_popular_name
  #`Count of most popular PTM` = most_popular_count
) %>% 
  knitr::kable() 

```

### `r htmltools::tags$h4("GUPPI analysis parameters")`

False detection rate: `r fdr*100`%

Taxon number of UniProt database: `r as.integer(taxonNumber)`

Taxon for determination of subcellular locations: `r GOLocType`

Fraction assignment: `r fracAss`

GUPPI version: `r GUPPI_version`

Row {data-height=600}
-----------------------------------------------------------------------

### `r htmltools::tags$h4("PTM summary")`

```{r}

results_proteoform_modcounts %>% 
  dplyr::select(tdreport_name, dplyr::everything()) %>% 
  DT::datatable(
    extensions = c("Buttons", "Scroller"),
    class = "wrap",
    options = list(
      autoWidth = TRUE,
      deferRender = TRUE,
      scrollY = "425px",
      scrollX = "600px",
      scroller = TRUE,
      columnDefs = list(
        list(
          className = 'dt-center'
        )
      ),
      dom = "Bfrtip",
      buttons = c("copy", "csv", "excel", "colvis")
    )
  ) %>% 
  DT::formatStyle(
    1:length(results_resultparameters),
    fontSize = "9"
  ) %>% 
  DT::formatStyle(
    3,
    columnWidth = "100px",
    fontSize = "6"
  )

```

Row {data-height=600}
-----------------------------------------------------------------------

### `r htmltools::tags$h4("Search parameters")`

```{r}

results_resultparameters %>% 
  dplyr::mutate(
    Value = 
      stringr::str_replace_all(Value, stringr::fixed(","), ";")
  ) %>% 
  dplyr::select(
    tdreport_name, ResultSet, Name, Value, IsActive, GroupName, dplyr::everything()
  ) %>% 
  DT::datatable(
    extensions = c("Buttons", "Scroller"),
    class = "wrap",
    options = list(
      autoWidth = TRUE,
      deferRender = TRUE,
      scrollY = "425px",
      scrollX = "600px",
      scroller = TRUE,
      columnDefs = list(
        list(
          className = 'dt-center'
        )
      ),
      dom = "Bfrtip",
      buttons = c("copy", "csv", "excel", "colvis")
    )
  ) %>% 
  DT::formatStyle(
    1:length(results_resultparameters),
    fontSize = "9"
  ) %>% 
  DT::formatStyle(
    3,
    columnWidth = "100px",
    fontSize = "6"
  )

```

Row {data-width=600}
-----------------------------------------------------------------------

### `r htmltools::tags$h4("Protein ID UpSet for analyzed TDReports")`

```{r, fig.width=10, fig.height=6, dpi = 200}

if (length(filelist) > 1) {
  
  proteins_list <- 
    results_protein %>%
    .[1:(length(.) - 1)] %>% 
    map(~.$UNIPROTKB) %>% 
    set_names(
      map(filelist, basename) %>% 
        map(tools::file_path_sans_ext) %>% 
        map(str_wrap, width = 15)
    )
  
  UpSetR::upset(
    UpSetR::fromList(proteins_list),
    nintersects = NA,
    sets.x.label = "Total Protein IDs",
    keep.order = T,
    mainbar.y.label = "Unique Protein IDs in Intersection",
    text.scale =  c(2, 2.5, 2, 2, 1.5, 2),
    point.size = 4,
    line.size = 1.5,
    group.by = "degree"
  )
  
} else {
  
  pander::pander("Only one TDReport analyzed, no UpSet plot made") 
  
}

```

### `r htmltools::tags$h4("Proteoform ID UpSet for analyzed TDReports")`

```{r, fig.width=10, fig.height=6, dpi = 200}

if (length(filelist) > 1) {
  
  pfrms_list <- 
    results_proteoform %>%
    .[1:(length(.) - 1)] %>% 
    map(~.$ProteoformRecordNum) %>% 
    set_names(
      map(filelist, basename) %>% 
        map(tools::file_path_sans_ext) %>% 
        map(str_wrap, width = 15)
    )
  
  UpSetR::upset(
    UpSetR::fromList(pfrms_list),
    nintersects = NA,
    sets.x.label = "Total Proteoform IDs",
    keep.order = T,
    mainbar.y.label = "Unique Proteoform IDs in Intersection",
    text.scale =  c(2, 2.5, 2, 2, 1.5, 2),
    point.size = 4,
    line.size = 1.5,
    group.by = "degree"
  )
  
} else {
  
  pander::pander("Only one TDReport analyzed, no UpSet plot made") 
  
}


```

<!-- For generating TDReport data tabs -->

```{r include=FALSE}

out <- NULL

options(knitr.duplicate.label = 'allow')

for (i in seq_along(filelist)) {
  
  out <- c(
    out, 
    knitr::knit_child(
      system.file(
        "rmd",
        "generate_dashboard_child.Rmd",
        package = "GUPPI"
      )    
    )
  )
  
}

```

`r paste(knitr::knit_child(text = out), collapse = '')`

# About

<br>

GUPPI is developed by [David S. Butcher](http://www.davidsbutcher.com) and provided as a service by the biological applications subgroup of the ICR group at the [National High Magnetic Field Laboratory](http://www.nationalmaglab.org).

`r fa("readme")` [Read the package documentation](http://davidsbutcher.github.io/GUPPI/)

`r fa("github")` [View source code on Github](http://github.com/davidsbutcher/GUPPI)

`r fa("envelope")` [Contact the package author](mailto:dbutcher@magnet.fsu.edu)

<br>

