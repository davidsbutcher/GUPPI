`r paste('#', basename(filelist[[i]]), '{data-navmenu="TDReport Filename"}')`

`r htmltools::tags$h3(basename(filelist[[i]]), style="text-align:center;color:#ffffff")`

```{r setup, include=FALSE}

# knitr::opts_knit$set(base.dir = normalizePath(tempdir(), winslash = '/'))

library(flexdashboard)
library(shiny)
library(shinydashboard)
library(magrittr)
library(stringr)
library(forcats)
library(purrr)
library(UpSetR)
library(ggplot2)
library(DT)
library(plotly)
library(ggthemes)
library(viridis)
library(waffle)
library(dplyr)
library(magick)

# Plotly parameters

download_button_params <- 
  list(
    format = "svg",
    width = 800,
    height = 500
  )

# ggplot themes

col_plot_theme <- 
  list(
    theme_minimal(),
    theme(
      axis.text.x = element_text(angle = 90),
      panel.grid.major.x = element_blank()
    )
  )

heatmap_theme <- 
  list(
    theme_minimal(),
    theme(
      text = element_text(size=16)
    ) 
  )

```

Row {.tabset .tabset-fade data-height=750}
-------------------------------------

### Table `r i`a, Protein Identifications

```{r echo=FALSE}

results_protein[[i]] %>%
  mutate(filename = sub('(^[^_]+_[^_]+_[^_]+)_(.*)$', '\\1_ \\2', filename)) %>%
  mutate(
    `PROTEIN-NAMES` = 
      stringr::str_trunc(`PROTEIN-NAMES`, 60, "right", ellipsis = "..."
      )
  ) %>% 
  mutate(GlobalQvalue = formatC(GlobalQvalue, format = "e", digits = 3)) %>%
  mutate(GRAVY = formatC(GRAVY, format = "f", digits = 3)) %>% 
  mutate(MonoisotopicMass = formatC(MonoisotopicMass, format = "f", digits = 4)) %>% 
  mutate(AverageMass = formatC(AverageMass, format = "f", digits = 4)) %>%
  dplyr::select(
    "UNIPROTKB",
    "PROTEIN-NAMES",
    "GlobalQvalue",
    "ObservedPrecursorMass",
    "MonoisotopicMass",
    "GRAVY",
    "fraction",
    "filename",
    everything()
  ) %>%
  dplyr::rename(
    "UniProt Accession" = UNIPROTKB,
    "Protein Name" = `PROTEIN-NAMES`,
    "Global Q-value" = GlobalQvalue,
    "Obs. Precursor Mass" = ObservedPrecursorMass,
    "Monoiso. Mass" = MonoisotopicMass,
    "GRAVY Score" = GRAVY,
    "Fraction" = fraction,
    "Filename" = filename
  ) %>% 
  DT::datatable(
    extensions = c("FixedColumns", "Buttons", "Scroller"),
    class = "hover",
    options = list(
      deferRender = TRUE,
      scrollY = 550,
      scrollX = TRUE,
      scroller = TRUE,
      columnDefs = list(
        list(
          visible = FALSE,
          targets = c(8:length(results_protein[[i]]))
        ),
        list(
          className = 'dt-center'
        )
      ),
      dom = "Bfrtip",
      fixedColumns = list(leftColumns = 2),
      buttons = c("copy", "csv", "excel", "colvis")
    )
  ) %>% 
  DT::formatStyle(
    1:length(results_protein[[i]]),
    fontSize = "9",
    digits = 3
  )

```

### Table `r i`b, Proteoform Identifications

```{r}

results_proteoform[[i]] %>%
  mutate(filename = sub('(^[^_]+_[^_]+_[^_]+)_(.*)$', '\\1_ \\2', filename)) %>%
  mutate(
    `PROTEIN-NAMES` = 
      stringr::str_trunc(`PROTEIN-NAMES`, 60, "right", ellipsis = "..."
      )
  ) %>% 
  mutate(GlobalQvalue = formatC(GlobalQvalue, format = "e", digits = 2)) %>%
  mutate(GRAVY = formatC(GRAVY, format = "f", digits = 3)) %>% 
  mutate(MonoisotopicMass = formatC(MonoisotopicMass, format = "f", digits = 4)) %>% 
  mutate(AverageMass = formatC(AverageMass, format = "f", digits = 4)) %>%
  dplyr::select(
    "UNIPROTKB",
    "ProteoformRecordNum",
    "PROTEIN-NAMES",
    "GlobalQvalue",
    "ObservedPrecursorMass",
    "MonoisotopicMass",
    "Modification",
    "HitCount",
    "GRAVY",
    "fraction",
    "filename",
    everything()
  ) %>%
  dplyr::rename(
    "UniProt Accession" = UNIPROTKB,
    "Proteoform Record Num." = ProteoformRecordNum,
    "Protein Name" = `PROTEIN-NAMES`,
    "Global Q-value" = GlobalQvalue,
    "Obs. Precursor Mass" = ObservedPrecursorMass,
    "Monoiso. Mass" = MonoisotopicMass,
    "Hit Count" = HitCount,
    "GRAVY Score" = GRAVY,
    "Fraction" = fraction,
    "Filename" = filename
  ) %>% 
  DT::datatable(
    extensions = c("FixedColumns", "Buttons", "Scroller"),
    class = "hover",
    options = list(
      deferRender = TRUE,
      scrollY = 550,
      scrollX = TRUE,
      scroller = TRUE,
      columnDefs = list(
        list(
          visible = FALSE,
          targets = c(9:length(results_proteoform[[i]]))
        ),
        list(
          className = 'dt-center'
        )
      ),
      dom = "Bfrtip",
      fixedColumns = list(leftColumns = 2),
      buttons = c("copy", "csv", "excel", "colvis")
    )
  ) %>% 
  DT::formatStyle(
    1:length(results_proteoform[[i]]),
    fontSize = "9",
    digits = 3
  )

```

Row {.tabset .tabset-fade}
-------------------------------------

### Protein Counts by Fraction

```{r}

plot <- 
  results_protein[[i]] %>% 
  group_by(fraction) %>% 
  summarise("protein count" = n()) %>%
  ggplot() +
  geom_col(
    aes(fraction, `protein count`),
    color = "black",
    fill = "#4C4184",
    size = 0.25
  ) +
  labs(
    x = "Fraction",
    y = "Protein Count"
  ) +
  col_plot_theme

plotly::ggplotly(plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::layout(
    xaxis = list(
      tickfont = list(
        size = 12
      )
    )
  )

```

### Protein Counts by Filename

``` {r}

plot <- 
  results_protein[[i]] %>% 
  group_by(filename) %>% 
  summarise("protein count" = n()) %>%
  mutate(filename = sub('(^[^_]+_[^_]+_[^_]+)_(.*)$', '\\1_ \\2', filename)) %>% 
  # mutate(filename = stringr::str_trunc(filename, 40, side = "left")) %>%
  ggplot() +
  geom_col(
    aes(filename, `protein count`),
    color = "black",
    fill = "#4C4184",
    size = 0.25
  ) +
  labs(
    x = "Filename",
    y = "Protein Count"
  ) +
  guides(
    color = "none",
    fill = "none"
  ) +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 8)) +
  col_plot_theme

plotly::ggplotly(plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::layout(
    xaxis = list(
      tickfont = list(
        size = 8
      )
    )
  )

```


Row
-------------------------------------

### Proteoform Identifications, UpSet Plot

```{r dpi=300, echo=FALSE}

results_protein_allhits[[i]] %>% 
  dplyr::select(
    ProteoformRecordNum,
    fraction
  ) %>%
  dplyr::arrange(fraction) %>%
  tidyr::pivot_wider(
    names_from = fraction,
    values_from =
      "ProteoformRecordNum",
    values_fn = list,
    names_prefix = "Frac_"
  ) %>%
  purrr::flatten() %>%
  list() %>%
  rlang::set_names("1") %>% 
  make_UpSet_plot()

```


### Proteoform Identifications, Intersection Degree Plot

```{r}

results_protein_allhits[[i]] %>% 
  dplyr::select(
    ProteoformRecordNum,
    fraction
  ) %>%
  dplyr::arrange(fraction) %>%
  tidyr::pivot_wider(
    names_from = fraction,
    values_from =
      ProteoformRecordNum,
    values_fn = list,
    names_prefix = "Frac_"
  ) %>%
  purrr::flatten() %>%
  purrr::map(unique) %>% 
  make_intersection_degree_plot(
    Yrange = c(0, 100),
    plotType = "Proteoform"
  ) %>% 
  plotly::ggplotly() %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  )

```

Row {data-height=500}
-------------------------------------

### Proteoform Identifications, Heatmap (Bin size = 1 kDa)

```{r}

results_protein_allhits[[i]] %>% 
  dplyr::group_by(
    ProteoformRecordNum,
    fraction
  ) %>% 
  viztools::make_heatmap(
    plotType = "Proteoform",
    orientation = "v",
    binSize = 1000,
    massColname = "ObservedPrecursorMass",
    fractionColname = "fraction"
  ) %>% 
  plotly::ggplotly() %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  )

```

### Proteoform Identifications Heatmap, Result Sets (Bin size = 1 kDa)

```{r}

proteoform_resultset_heatmap <- 
  results_proteoform[[i]] %>% 
  dplyr::mutate(ResultSet = stringr::str_wrap(ResultSet,10)) %>%
  ggplot(aes(ObservedPrecursorMass/1000, ResultSet)) +
  geom_bin2d(aes(group = ResultSet), position = "identity", stat = "bin2d") +
  scale_fill_viridis_c(option = "C", direction = -1) +
  labs(
    x = "Mass Bin (kDa)",
    y = "Result Set"
  ) +
  theme_minimal() +
  theme(text = ggplot2::element_text(size=18))

plotly::ggplotly(proteoform_resultset_heatmap) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  )


```

Row
-------------------------------------

### Proteoform Identifications, Waffle Plot

```{r, out.width="100%"}

waffle1 <- 
  results_protein_countsbyfraction %>%
  dplyr::filter(tdreport_name == basename(filelist[[i]])) %>%
  dplyr::ungroup() %>% 
  dplyr::select(-tdreport_name) %>% 
  viztools::waffle_iron(
    fraction_colname = "fraction"
  )

fig1 <- image_graph(height = 2400, width = 3200, res = 300)

waffle1

dev.off()

magick::image_trim(fig1)


```

Row
-------------------------------------

### Hit Count vs. Intact Monoisotopic Mass

```{r}

allhits_sum <- 
  results_protein_allhits[[i]] %>% 
  mutate(MonoisotopicMass = MonoisotopicMass/1000) %>% 
  dplyr::rename(`MonoisotopicMass (kDa)` = MonoisotopicMass) %>% 
  group_by(
    AccessionNumber,
    `MonoisotopicMass (kDa)`
  ) %>% 
  summarize(`Hit Count` = n()) %>% 
  ungroup()

allhits_linear_plot <- 
  allhits_sum %>% 
  ggplot(aes(`MonoisotopicMass (kDa)`, `Hit Count`)) +
  geom_point(size = 2) +
  labs(
    x = "Intact Monoisotopic Mass (kDa)",
    y = "Hit Count"
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks()
  ) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(size = 12)
  )

allhits_log10_plot <- 
  allhits_sum %>% 
  ggplot(aes(`MonoisotopicMass (kDa)`, log10(`Hit Count`))) +
  geom_point(size = 2) +
  labs(
    x = "Intact Monoisotopic Mass (kDa)",
    y = "Log10(Hit Count)"
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks()
  ) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(size = 12)
  )

p1 <- 
  plotly::ggplotly(allhits_linear_plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::style(
    marker = list(
      size = 3,
      color = "black"
    )
  )

p2 <- 
  plotly::ggplotly(allhits_log10_plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::style(
    marker = list(
      size = 3,
      color = "black"
    )
  )

plotly::subplot(p1, p2, shareX = T, shareY = F, titleY = T, titleX = T)

```

Row
-------------------------------------

### Proteoform Identification Heatmap, -Log10(Q-value) vs. Mass

Bin size: 1 kilodalton

```{r}
allhits_qvals <- 
  results_proteoform[[i]] %>%
  mutate(MonoisotopicMass = MonoisotopicMass/1000) %>% 
  dplyr::rename(`MonoisotopicMass (kDa)` = MonoisotopicMass)

allhits_qvals_plot <- 
  allhits_qvals %>% 
  ggplot(aes(`MonoisotopicMass (kDa)`, -log10(GlobalQvalue))) +
  geom_point(size = 2) +
  labs(
    x = "Intact Monoisotopic Mass (kDa)",
    y = "-Log10(Global Q-value)"
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks()
  ) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(size = 12)
  )

plotly::ggplotly(allhits_qvals_plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::style(
    marker = list(
      size = 3,
      color = "black"
    )
  )


```

