`r paste('#', basename(filelist[[i]]), '{data-navmenu="TDReport Filename"}')`

`r shiny::tags$h3(basename(filelist[[i]]), style="text-align:center")`

```{r setup, include=FALSE}

knitr::opts_knit$set(base.dir = normalizePath(tempdir(), winslash = '/'))

library(dplyr)
library(flexdashboard)
library(shiny)
library(shinydashboard)
library(magrittr)
library(stringr)
library(purrr)
library(UpSetR)
library(ggplot2)
library(DT)
library(plotly)
library(ggthemes)
library(viridis)
library(waffle)

# Plotly parameters

download_button_params <- 
  list(
    format = "svg",
    width = 800,
    height = 500
  )

# ggplot themes

col_plot_theme <- 
  list(
    theme_minimal(),
    theme(
      axis.text.x = element_text(angle = 90),
      panel.grid.major.x = element_blank()
    )
  )

heatmap_theme <- 
  list(
    theme_minimal(),
    theme(
      text = element_text(size=16)
    ) 
  )

```

Row {.tabset .tabset-fade data-height=750}
-------------------------------------

### Table S`r i`a, Best Protein Hits

```{r echo=FALSE}

results_protein[[i]] %>%
  mutate(filename = sub('(^[^_]+_[^_]+_[^_]+)_(.*)$', '\\1_ \\2', filename)) %>%
  mutate(
    `PROTEIN-NAMES` = 
      stringr::str_trunc(`PROTEIN-NAMES`, 60, "right", ellipsis = "..."
      )
  ) %>% 
  mutate(GlobalQvalue = formatC(GlobalQvalue, format = "e", digits = 3)) %>%
  mutate(GRAVY = formatC(GRAVY, format = "f", digits = 3)) %>% 
  mutate(MonoisotopicMass = formatC(MonoisotopicMass, format = "f", digits = 4)) %>% 
  mutate(AverageMass = formatC(AverageMass, format = "f", digits = 4)) %>%
  dplyr::select(
    "UNIPROTKB",
    "PROTEIN-NAMES",
    "GlobalQvalue",
    "ObservedPrecursorMass",
    "MonoisotopicMass",
    "GRAVY",
    "fraction",
    "filename",
    everything()
  ) %>%
  dplyr::rename(
    "UniProt Accession" = UNIPROTKB,
    "Protein Name" = `PROTEIN-NAMES`,
    "Global Q-value" = GlobalQvalue,
    "Obs. Precursor Mass" = ObservedPrecursorMass,
    "Monoiso. Mass" = MonoisotopicMass,
    "GRAVY Score" = GRAVY,
    "Fraction" = fraction,
    "Filename" = filename
  ) %>% 
  DT::datatable(
    extensions = c("FixedColumns", "Buttons", "Scroller"),
    class = "hover",
    options = list(
      deferRender = TRUE,
      scrollY = 550,
      scrollX = TRUE,
      scroller = TRUE,
      columnDefs = list(
        list(
          visible = FALSE,
          targets = c(8:length(results_protein[[i]]))
        ),
        list(
          className = 'dt-center'
        )
      ),
      dom = "Bfrtip",
      fixedColumns = list(leftColumns = 2),
      buttons = c("copy", "csv", "excel", "colvis")
    )
  ) %>% 
  DT::formatStyle(
    1:length(results_protein[[i]]),
    fontSize = "9",
    digits = 3
  )

```

### Table S`r i`b, Best Proteoform Hits

```{r}

results_proteoform[[i]] %>%
  mutate(filename = sub('(^[^_]+_[^_]+_[^_]+)_(.*)$', '\\1_ \\2', filename)) %>%
  mutate(
    `PROTEIN-NAMES` = 
      stringr::str_trunc(`PROTEIN-NAMES`, 60, "right", ellipsis = "..."
      )
  ) %>% 
  mutate(GlobalQvalue = formatC(GlobalQvalue, format = "e", digits = 2)) %>%
  mutate(GRAVY = formatC(GRAVY, format = "f", digits = 3)) %>% 
  mutate(MonoisotopicMass = formatC(MonoisotopicMass, format = "f", digits = 4)) %>% 
  mutate(AverageMass = formatC(AverageMass, format = "f", digits = 4)) %>%
  dplyr::select(
    "UNIPROTKB",
    "ProteoformRecordNum",
    "PROTEIN-NAMES",
    "GlobalQvalue",
    "ObservedPrecursorMass",
    "MonoisotopicMass",
    "Modification",
    "GRAVY",
    "fraction",
    "filename",
    everything()
  ) %>%
  dplyr::rename(
    "UniProt Accession" = UNIPROTKB,
    "Proteoform Record Num." = ProteoformRecordNum,
    "Protein Name" = `PROTEIN-NAMES`,
    "Global Q-value" = GlobalQvalue,
    "Obs. Precursor Mass" = ObservedPrecursorMass,
    "Monoiso. Mass" = MonoisotopicMass,
    "GRAVY Score" = GRAVY,
    "Fraction" = fraction,
    "Filename" = filename
  ) %>% 
  DT::datatable(
    extensions = c("FixedColumns", "Buttons", "Scroller"),
    class = "hover",
    options = list(
      deferRender = TRUE,
      scrollY = 550,
      scrollX = TRUE,
      scroller = TRUE,
      columnDefs = list(
        list(
          visible = FALSE,
          targets = c(9:length(results_proteoform[[i]]))
        ),
        list(
          className = 'dt-center'
        )
      ),
      dom = "Bfrtip",
      fixedColumns = list(leftColumns = 2),
      buttons = c("copy", "csv", "excel", "colvis")
    )
  ) %>% 
  DT::formatStyle(
    1:length(results_proteoform[[i]]),
    fontSize = "9",
    digits = 3
  )

```

Row {.tabset .tabset-fade}
-------------------------------------

### Protein Counts by Fraction

```{r}

plot <- 
  results_protein[[i]] %>% 
  group_by(fraction) %>% 
  summarise("protein count" = n()) %>%
  ggplot() +
  geom_col(
    aes(fraction, `protein count`),
    color = "black",
    fill = "#4C4184",
    size = 0.25
  ) +
  labs(
    x = "Fraction",
    y = "Protein Count"
  ) +
  col_plot_theme

plotly::ggplotly(plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::layout(
    xaxis = list(
      tickfont = list(
        size = 12
      )
    )
  )

```

### Protein Counts by Filename

``` {r}

plot <- 
  results_protein[[i]] %>% 
  group_by(filename) %>% 
  summarise("protein count" = n()) %>%
  mutate(filename = sub('(^[^_]+_[^_]+_[^_]+)_(.*)$', '\\1_ \\2', filename)) %>% 
  # mutate(filename = stringr::str_trunc(filename, 40, side = "left")) %>%
  ggplot() +
  geom_col(
    aes(filename, `protein count`),
    color = "black",
    fill = "#4C4184",
    size = 0.25
  ) +
  labs(
    x = "Filename",
    y = "Protein Count"
  ) +
  guides(
    color = "none",
    fill = "none"
  ) +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 8)) +
  col_plot_theme

plotly::ggplotly(plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::layout(
    xaxis = list(
      tickfont = list(
        size = 8
      )
    )
  )

```

Row
-------------------------------------

### Protein Heatmaps, Best Protein Hits

This heatmap contains no redundant accession numbers.

```{r}

bin_size <- 1000   # SPECIFY SIZE for heatmap mass bins
bins <-  seq.int(0, 200000, by = bin_size)

protein_heatmap_data <- 
  results_protein[[i]] %>% 
  select(c("ObservedPrecursorMass", "fraction")) %>% 
  mutate(mass_bin = cut(ObservedPrecursorMass, breaks = bins, labels = FALSE)) %>%
  group_by(fraction, mass_bin) %>% 
  summarize("Protein Count" = n()) %>%
  mutate(mass_bin =  (mass_bin * bin_size) - bin_size) %>% 
  ungroup() %>% 
  mutate(fraction = forcats::as_factor(fraction)) %>% 
  mutate(`Mass Bin (kDa)` = mass_bin/1000) %>% 
  rename("Fraction" = fraction)

protein_heatmap <- 
  protein_heatmap_data %>% 
  ggplot(
    aes(
      `Mass Bin (kDa)`, 
      Fraction,
      fill = `Protein Count`
    )
  ) +
  geom_tile() +
  scale_fill_viridis_c(option = "C", direction = -1) +
  xlim(
    0,
    plyr::round_any(
      max(protein_heatmap_data$`Mass Bin (kDa)`),
      10, f = ceiling
    )
  ) +
  scale_y_discrete(limits = rev(levels(protein_heatmap_data$Fraction))) +
  labs(
    x = "Mass Bin (kDa)",
    y = "Fraction"
  ) +
  heatmap_theme

# print(protein_heatmap)

plotly::ggplotly(protein_heatmap) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  )



```

Row
-------------------------------------

### Proteoform Heatmaps, Best Proteoform Hits

This heatmap contains no redundant proteoform record numbers.

```{r}

bin_size <- 1000   # SPECIFY SIZE for heatmap mass bins
bins <-  seq.int(0, 200000, by = bin_size)

proteoform_heatmap_data <- 
  results_proteoform[[i]] %>% 
  select(c("ObservedPrecursorMass", "fraction")) %>% 
  mutate(mass_bin = cut(ObservedPrecursorMass, breaks = bins, labels = FALSE)) %>%
  group_by(fraction, mass_bin) %>% 
  summarize(n()) %>%
  mutate(mass_bin =  (mass_bin * bin_size) - bin_size) %>% 
  rename("Proteoform Count" = `n()`) %>%
  ungroup() %>% 
  mutate(fraction = forcats::as_factor(fraction)) %>% 
  mutate(`Mass Bin (kDa)` = mass_bin/1000) %>% 
  rename("Fraction" = fraction)

proteoform_heatmap <- 
  proteoform_heatmap_data %>% 
  ggplot(
    aes(`Mass Bin (kDa)`, Fraction, fill = `Proteoform Count`)
  ) +
  geom_tile() +
  scale_fill_viridis_c(option = "C", direction = -1) +
  xlim(
    0,
    plyr::round_any(
      max(proteoform_heatmap_data$`Mass Bin (kDa)`),
      10, f = ceiling
    )
  ) +
  scale_y_discrete(limits = rev(levels(proteoform_heatmap_data$Fraction))) +
  labs(
    x = "Mass Bin (kDa)",
    y = "Fraction"
  ) +
  theme_minimal() +
  theme(text = element_text(size=18))

plotly::ggplotly(proteoform_heatmap) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  )


```

Row
-------------------------------------

### Result Set Proteoform Heatmaps

```{r}

proteoform_resultset_heatmap <- 
  results_proteoform[[i]] %>% 
  dplyr::mutate(ResultSet = stringr::str_wrap(ResultSet,10)) %>%
  ggplot(aes(ObservedPrecursorMass/1000, ResultSet)) +
  geom_bin2d(aes(group = ResultSet), position = "identity", stat = "bin2d") +
  scale_fill_viridis_c(option = "C", direction = -1) +
  labs(
    x = "Mass Bin (kDa)",
    y = "Result Set"
  ) +
  theme_minimal() +
  theme(text = ggplot2::element_text(size=18))

plotly::ggplotly(proteoform_resultset_heatmap) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  )


```

Row
-------------------------------------

### Hit Count vs. Mass, All hits

```{r}
allhits_sum <- 
  results_protein_allhits[[i]] %>% 
  mutate(MonoisotopicMass = MonoisotopicMass/1000) %>% 
  dplyr::rename(`MonoisotopicMass (kDa)` = MonoisotopicMass) %>% 
  group_by(
    AccessionNumber,
    `MonoisotopicMass (kDa)`
  ) %>% 
  summarize(`Hit Count` = n()) %>% 
  ungroup()

allhits_linear_plot <- 
  allhits_sum %>% 
  ggplot(aes(`MonoisotopicMass (kDa)`, `Hit Count`)) +
  geom_point(size = 2) +
  labs(
    x = "Intact Monoisotopic Mass (kDa)",
    y = "Hit Count"
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks()
  ) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(size = 12)
  )

allhits_log10_plot <- 
  allhits_sum %>% 
  ggplot(aes(`MonoisotopicMass (kDa)`, log10(`Hit Count`))) +
  geom_point(size = 2) +
  labs(
    x = "Intact Monoisotopic Mass (kDa)",
    y = "Log10(Hit Count)"
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks()
  ) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(size = 12)
  )

p1 <- 
  plotly::ggplotly(allhits_linear_plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::style(
    marker = list(
      size = 3,
      color = "black"
    )
  )

p2 <- 
  plotly::ggplotly(allhits_log10_plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::style(
    marker = list(
      size = 3,
      color = "black"
    )
  )

plotly::subplot(p1, p2, shareX = T, shareY = F, titleY = T, titleX = T)

```

Row
-------------------------------------

### Q-values vs. Mass, Proteoform

```{r}
allhits_qvals <- 
  results_proteoform[[i]] %>%
  mutate(MonoisotopicMass = MonoisotopicMass/1000) %>% 
  dplyr::rename(`MonoisotopicMass (kDa)` = MonoisotopicMass)

allhits_qvals_plot <- 
  allhits_qvals %>% 
  ggplot(aes(`MonoisotopicMass (kDa)`, -log10(GlobalQvalue))) +
  geom_point(size = 2) +
  labs(
    x = "Intact Monoisotopic Mass (kDa)",
    y = "-Log10(Global Q-value)"
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks()
  ) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(size = 12)
  )

  plotly::ggplotly(allhits_qvals_plot) %>% 
  plotly::config(
    displaylogo = FALSE,
    toImageButtonOptions = download_button_params
  ) %>% 
  plotly::style(
    marker = list(
      size = 3,
      color = "black"
    )
  )


```

<!-- Row -->
<!-- ------------------------------------- -->

<!-- ### Protein Waffle Plots -->

<!-- ```{r} -->

<!-- counts_byfrac_fltrd <-  -->
<!--   results_protein_countsbyfraction %>% -->
<!--   filter(tdreport_name == basename(filelist[[i]])) -->

<!-- fractionlist <-  -->
<!--   counts_byfrac_fltrd %>%  -->
<!--   .$fraction %>% -->
<!--   as.list -->

<!-- waffledata_protein_all_byfraction <-  -->
<!--   tibble( -->
<!--     Localization = factor( -->
<!--       c( -->
<!--         rep("Cytosolic", length(fractionlist)), -->
<!--         rep("Membrane", length(fractionlist)), -->
<!--         rep("Periplasmic", length(fractionlist)), -->
<!--         rep("Unannotated", length(fractionlist)) -->
<!--       ) -->
<!--     ), -->
<!--     Count = c( -->
<!--       counts_byfrac_fltrd$cytosol_count, -->
<!--       counts_byfrac_fltrd$membrane_count, -->
<!--       counts_byfrac_fltrd$periplasm_count, -->
<!--       counts_byfrac_fltrd$NOTA_count -->
<!--     ), -->
<!--     fraction = rep(counts_byfrac_fltrd$fraction, 4) -->
<!--   ) %>% -->
<!--   group_by(fraction, Localization) %>%  -->
<!--   summarize(Count) -->

<!-- output <- -->
<!--   waffledata_protein_all_byfraction %>% -->
<!--   ggplot(aes(fill = Localization, values = Count)) + -->
<!--   waffle::stat_waffle( -->
<!--     color = "white", size = 0.2, n_rows = 10, -->
<!--     flip = TRUE, geom = "tile" -->
<!--   ) + -->
<!--   facet_wrap(~fraction, nrow = 1, strip.position = c("bottom")) + -->
<!--   scale_x_discrete(expand=c(0,0)) + -->
<!--   scale_y_continuous( -->
<!--     labels = function(x) x * 10, # this multiplier must be equal to n_rows above -->
<!--     expand = c(0,0) -->
<!--   ) + -->
<!--   ggplot2::scale_fill_viridis_d(option = "plasma", begin = 0, end = 0.85) + -->
<!--   coord_equal() + -->
<!--   labs( -->
<!--     x = "Fraction Number", -->
<!--     y = "Protein Count" -->
<!--   ) + -->
<!--   theme_minimal() + -->
<!--   theme(panel.grid = element_blank(), axis.ticks.y = element_line()) + -->
<!--   guides(fill = guide_legend("Localization", reverse = TRUE)) -->

<!-- plotly::ggplotly(output, originalData = FALSE, tooltip = "Localization") %>% -->
<!--   plotly::config( -->
<!--     displaylogo = FALSE, -->
<!--     toImageButtonOptions = download_button_params -->
<!--   ) -->

<!-- ``` -->

Row
-------------------------------------

### Unique Proteoforms per Accession

```{r}

results_proteoform[[i]] %>% 
  group_by(UNIPROTKB) %>% 
  summarize(
    `Unique Proteoforms` = n()
  ) %>% 
  rename("UniProt Accession" = UNIPROTKB) %>% 
  DT::datatable(
    extensions = c("FixedColumns", "Buttons"),
    class = "hover",
    options = list(
      pageLength = 10,
      lengthMenu = c(10, 25),
      pagingType = "full_numbers",
      columnDefs = list(
        list(
          className = 'dt-center'
        )
      ),
      dom = "Bfrtip",
      scrollX = FALSE,
      buttons = c("copy", "csv", "excel")
    )
  ) %>% 
  DT::formatStyle(
    1:2,
    fontSize = "9"
  )


```

